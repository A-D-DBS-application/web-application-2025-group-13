{% extends "base.html" %}

{% block styles %}
<style>
    /* CONTAINER & BASIS */
    .intake-container {
        max-width: 800px;
        width: 95%;
        margin: 30px auto;
        background: white;
        border-radius: 20px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.08);
        padding: 30px;
        min-height: 60vh;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
    }

    h2 { color: #007B7F; margin-bottom: 10px; }
    p.desc { color: #666; margin-bottom: 25px; }

    /* STAP INDICATOR (Bovenaan) */
    .progress-bar {
        display: flex;
        justify-content: space-between;
        margin-bottom: 30px;
        position: relative;
    }
    .progress-step {
        width: 18%;
        height: 6px;
        background: #eee;
        border-radius: 3px;
        transition: background 0.3s;
    }
    .progress-step.active { background: #007B7F; }

    /* VRAAG STYLING */
    label.question-label {
        font-weight: 700;
        font-size: 1.1rem;
        color: #333;
        display: block;
        margin-bottom: 10px;
        margin-top: 20px;
    }

    input[type="text"], input[type="number"] {
        width: 100%; padding: 12px; border: 2px solid #eee; border-radius: 10px;
        font-size: 1rem; box-sizing: border-box; transition: border 0.2s;
    }
    input:focus { border-color: #007B7F; outline: none; }

    /* VISUELE SELECTIE CARDS (Radio/Checkbox vervangers) */
    .selection-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 15px;
    }

    /* Verberg de echte checkbox/radio */
    .hidden-input { display: none; }

    /* De stijl van het kaartje */
    .selection-card {
        border: 2px solid #eee;
        border-radius: 12px;
        padding: 15px;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s;
        background: #fafafa;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
    }
    .selection-card span.emoji { font-size: 2rem; margin-bottom: 8px; display: block; }
    .selection-card span.text { font-weight: 600; color: #555; }

    /* Als geselecteerd */
    .hidden-input:checked + .selection-card {
        border-color: #007B7F;
        background-color: #e0f7fa;
        transform: translateY(-3px);
        box-shadow: 0 4px 10px rgba(0,123,127,0.2);
    }
    .hidden-input:checked + .selection-card span.text { color: #007B7F; }

    /* TAGS (Voor muziek etc) */
    .tags-container { display: flex; flex-wrap: wrap; gap: 10px; }
    .tag-label {
        background: #f0f0f0; padding: 8px 16px; border-radius: 20px;
        cursor: pointer; font-weight: 500; color: #555; transition: 0.2s;
        border: 1px solid transparent;
    }
    .hidden-input:checked + .tag-label {
        background: #007B7F; color: white; border-color: #005f62;
    }

    /* KNOPPEN ONDERAAN */
    .actions {
        display: flex; justify-content: space-between; margin-top: 40px; padding-top: 20px; border-top: 1px solid #eee;
    }
    .btn { padding: 12px 25px; border-radius: 50px; border: none; font-weight: bold; cursor: pointer; font-size: 1rem; }
    .btn-prev { background: #f0f0f0; color: #666; }
    .btn-next { background: #007B7F; color: white; }
    .btn:hover { opacity: 0.9; }
    .hidden { display: none; }

    /* KALENDER (Behouden styling maar strakker) */
    .date-range-picker { background: #f9f9f9; padding: 15px; border-radius: 12px; border: 1px solid #eee; }
    .month-view { background: white; border-radius: 10px; padding: 10px; margin: 10px auto; max-width: 350px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
    .days { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; text-align: center; }
    .day { padding: 10px; cursor: pointer; border-radius: 5px; font-size: 0.9rem; }
    .day:hover:not(.disabled) { background: #e0f7fa; }
    .day.start, .day.end { background: #007B7F; color: white; }
    .day.in-range { background: #b2dfdb; }
    .day.disabled { color: #ccc; cursor: default; }
    .picker-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; font-weight: bold; color: #007B7F; }
    .nav-btn { background: none; border: 1px solid #007B7F; color: #007B7F; border-radius: 5px; cursor: pointer; padding: 2px 8px; }

</style>
{% endblock %}

{% block content %}
<div class="intake-container">
    
    <div class="progress-bar">
        <div class="progress-step active" id="p1"></div>
        <div class="progress-step" id="p2"></div>
        <div class="progress-step" id="p3"></div>
        <div class="progress-step" id="p4"></div>
        <div class="progress-step" id="p5"></div>
    </div>

    <form method="POST" action="/submit-intake" id="intakeForm">
        
        <section data-step="1" class="step-section">
            <h2>Wie ben jij? üë§</h2>
            <p class="desc">Laten we beginnen bij de basis.</p>
            
            <div style="display:flex; gap:20px;">
                <div style="flex:1;">
                    <label class="question-label">Jouw leeftijd</label>
                    <input type="number" name="age" placeholder="Bijv. 24" required min="18" max="99">
                </div>
                <div style="flex:2;">
                    <label class="question-label">Met welke leeftijd reis je het liefst?</label>
                    <div class="tags-container">
                        <label><input type="checkbox" name="age_pref[]" value="18-24" class="hidden-input"><span class="tag-label">18 - 24</span></label>
                        <label><input type="checkbox" name="age_pref[]" value="25-30" class="hidden-input"><span class="tag-label">25 - 30</span></label>
                        <label><input type="checkbox" name="age_pref[]" value="30-40" class="hidden-input"><span class="tag-label">30 - 40</span></label>
                        <label><input type="checkbox" name="age_pref[]" value="40+" class="hidden-input"><span class="tag-label">40+</span></label>
                        <label><input type="checkbox" name="age_pref[]" value="Maakt niet uit" class="hidden-input"><span class="tag-label">Maakt niet uit</span></label>
                    </div>
                </div>
            </div>

            <label class="question-label">Jouw droombestemming</label>
            <input type="text" name="destination" placeholder="Waar wil je h√©√©l graag heen?" required>
        </section>

        <section data-step="2" class="step-section hidden">
            <h2>Jouw Travel Vibe ‚ú®</h2>
            <p class="desc">Je mag meerdere opties kiezen!</p>

            <label class="question-label">Hoe omschrijf je jezelf?</label>
            <div class="selection-grid">
                <label>
                    <input type="checkbox" name="personality[]" value="Avontuurlijk" class="hidden-input">
                    <div class="selection-card"><span class="emoji">üåã</span><span class="text">Avontuurlijk</span></div>
                </label>
                <label>
                    <input type="checkbox" name="personality[]" value="Relaxed" class="hidden-input">
                    <div class="selection-card"><span class="emoji">üå¥</span><span class="text">Relaxed</span></div>
                </label>
                <label>
                    <input type="checkbox" name="personality[]" value="Feestbeest" class="hidden-input">
                    <div class="selection-card"><span class="emoji">üéâ</span><span class="text">Feestbeest</span></div>
                </label>
                <label>
                    <input type="checkbox" name="personality[]" value="Cultureel" class="hidden-input">
                    <div class="selection-card"><span class="emoji">üèõÔ∏è</span><span class="text">Cultuur</span></div>
                </label>
                <label>
                    <input type="checkbox" name="personality[]" value="Foodie" class="hidden-input">
                    <div class="selection-card"><span class="emoji">üçú</span><span class="text">Foodie</span></div>
                </label>
                <label>
                    <input type="checkbox" name="personality[]" value="Natuur" class="hidden-input">
                    <div class="selection-card"><span class="emoji">üå≤</span><span class="text">Natuur</span></div>
                </label>
            </div>

            <label class="question-label">Hoe slaap je het liefst?</label>
            <div class="tags-container">
                <label><input type="checkbox" name="comfort[]" value="Camping" class="hidden-input"><span class="tag-label">Tentje / Camping ‚õ∫</span></label>
                <label><input type="checkbox" name="comfort[]" value="Hostel" class="hidden-input"><span class="tag-label">Gezellig Hostel üéí</span></label>
                <label><input type="checkbox" name="comfort[]" value="Airbnb" class="hidden-input"><span class="tag-label">Airbnb / Huisje üè°</span></label>
                <label><input type="checkbox" name="comfort[]" value="Hotel" class="hidden-input"><span class="tag-label">Hotel Luxe üõéÔ∏è</span></label>
            </div>
        </section>

        <section data-step="3" class="step-section hidden">
            <h2>Wanneer & Hoeveel? üìÖ</h2>
            <p class="desc">Kies je beschikbare periodes in de kalender.</p>

            <div class="date-range-picker">
                <div class="picker-header">
                    <button type="button" id="prevMonth" class="nav-btn">&lt;</button>
                    <span id="monthTitle">Maand</span>
                    <button type="button" id="nextMonth" class="nav-btn">&gt;</button>
                </div>
                <div class="month-view">
                    <div style="display:grid; grid-template-columns:repeat(7,1fr); text-align:center; font-size:0.8rem; color:#888; margin-bottom:5px;">
                        <div>ma</div><div>di</div><div>wo</div><div>do</div><div>vr</div><div>za</div><div>zo</div>
                    </div>
                    <div class="days" id="daysGrid"></div>
                </div>
                <div style="text-align:center; margin-top:10px;">
                    <button type="button" id="addRangeBtn" class="btn" style="background:#eee; color:#333; font-size:0.9rem; padding:8px 15px;" disabled>+ Voeg periode toe</button>
                    <div id="rangesList" style="margin-top:10px; font-size:0.9rem; color:#007B7F;"></div>
                </div>
            </div>
            <div id="hiddenRangesContainer"></div>

            <label class="question-label" style="margin-top:30px;">Wat is je budget p.p.?</label>
            <div class="tags-container">
                <label><input type="radio" name="budget" value="Low" class="hidden-input"><span class="tag-label">‚Ç¨500 - ‚Ç¨1000</span></label>
                <label><input type="radio" name="budget" value="Medium" class="hidden-input"><span class="tag-label">‚Ç¨1000 - ‚Ç¨1800</span></label>
                <label><input type="radio" name="budget" value="High" class="hidden-input"><span class="tag-label">‚Ç¨1800 - ‚Ç¨3000</span></label>
                <label><input type="radio" name="budget" value="Luxe" class="hidden-input"><span class="tag-label">‚Ç¨3000+</span></label>
            </div>
        </section>

        <section data-step="4" class="step-section hidden">
            <h2>Muziek & Extra's üéß</h2>
            <p class="desc">Muziek verbindt! Waar ga jij lekker op?</p>

            <label class="question-label">Favoriete Genres (Kies er meerdere)</label>
            <div class="tags-container">
                <label><input type="checkbox" name="music[]" value="Pop" class="hidden-input"><span class="tag-label">Pop</span></label>
                <label><input type="checkbox" name="music[]" value="Techno" class="hidden-input"><span class="tag-label">Techno / House</span></label>
                <label><input type="checkbox" name="music[]" value="Rock" class="hidden-input"><span class="tag-label">Rock</span></label>
                <label><input type="checkbox" name="music[]" value="HipHop" class="hidden-input"><span class="tag-label">HipHop</span></label>
                <label><input type="checkbox" name="music[]" value="Indie" class="hidden-input"><span class="tag-label">Indie</span></label>
                <label><input type="checkbox" name="music[]" value="R&B" class="hidden-input"><span class="tag-label">R&B</span></label>
                <label><input type="checkbox" name="music[]" value="Foute uur" class="hidden-input"><span class="tag-label">Het Foute Uur</span></label>
            </div>

            <label class="question-label">Welke Festivals vind je tof?</label>
            <div class="tags-container">
                <label><input type="checkbox" name="festival[]" value="Tomorrowland" class="hidden-input"><span class="tag-label">Tomorrowland üßö‚Äç‚ôÄÔ∏è</span></label>
                <label><input type="checkbox" name="festival[]" value="Werchter" class="hidden-input"><span class="tag-label">Rock Werchter üé∏</span></label>
                <label><input type="checkbox" name="festival[]" value="Pukkelpop" class="hidden-input"><span class="tag-label">Pukkelpop üé™</span></label>
                <label><input type="checkbox" name="festival[]" value="Dour" class="hidden-input"><span class="tag-label">Dour üì£</span></label>
                <label><input type="checkbox" name="festival[]" value="Geen" class="hidden-input"><span class="tag-label">Geen festivalganger</span></label>
            </div>
        </section>

        <section data-step="5" class="step-section hidden">
            <h2>Bijna klaar! üöÄ</h2>
            <p class="desc">Check je antwoorden even.</p>
            
            <div id="reviewBox" style="background:#f9f9f9; padding:20px; border-radius:10px; line-height:1.8;">
                </div>
        </section>

        <div class="actions">
            <button type="button" class="btn btn-prev" disabled>Vorige</button>
            <button type="button" class="btn btn-next">Volgende</button>
            <button type="submit" class="btn btn-next hidden" id="submitBtn">Verstuur Intake</button>
        </div>

    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
(function(){
  // --- STAPPEN LOGICA ---
  const steps = Array.from(document.querySelectorAll('.step-section'));
  const progressSteps = document.querySelectorAll('.progress-step');
  const btnNext = document.querySelector('.btn-next');
  const btnPrev = document.querySelector('.btn-prev');
  const btnSubmit = document.getElementById('submitBtn');
  let currentStep = 0;

  function updateView(){
    steps.forEach((s, i) => s.classList.toggle('hidden', i !== currentStep));
    progressSteps.forEach((p, i) => p.classList.toggle('active', i <= currentStep));
    
    btnPrev.disabled = (currentStep === 0);
    
    if(currentStep === steps.length - 1){
        btnNext.classList.add('hidden');
        btnSubmit.classList.remove('hidden');
        buildReview();
    } else {
        btnNext.classList.remove('hidden');
        btnSubmit.classList.add('hidden');
    }
    window.scrollTo({top:0, behavior:'smooth'});
  }

  btnNext.addEventListener('click', () => {
    // Simpele validatie (kijk of required velden in huidige stap zijn ingevuld)
    const currentSection = steps[currentStep];
    const inputs = currentSection.querySelectorAll('input[required]');
    let valid = true;
    inputs.forEach(inp => { if(!inp.value) valid = false; });
    
    if(!valid) { alert('Vul a.u.b. alle verplichte velden in.'); return; }
    
    if(currentStep < steps.length - 1){ currentStep++; updateView(); }
  });

  btnPrev.addEventListener('click', () => {
    if(currentStep > 0){ currentStep--; updateView(); }
  });

  // --- REVIEW SAMENSTELLEN ---
  function buildReview(){
    const fd = new FormData(document.getElementById('intakeForm'));
    let html = '';
    
    // Helper om array values (checkboxes) mooi weer te geven
    const getVals = (name) => {
        const vals = fd.getAll(name); // pakt alle aangevinkte opties
        return vals.length ? vals.join(', ') : '-';
    };

    html += `<strong>Leeftijd:</strong> ${fd.get('age')}<br>`;
    html += `<strong>Leeftijdsvoorkeur:</strong> ${getVals('age_pref[]')}<br>`;
    html += `<strong>Droombestemming:</strong> ${fd.get('destination')}<br>`;
    html += `<br><strong>Persoonlijkheid:</strong> ${getVals('personality[]')}<br>`;
    html += `<strong>Slaapvoorkeur:</strong> ${getVals('comfort[]')}<br>`;
    html += `<strong>Budget:</strong> ${fd.get('budget') || '-'}<br>`;
    
    const starts = fd.getAll('travel_start[]');
    const ends = fd.getAll('travel_end[]');
    if(starts.length){
        html += `<br><strong>Reisperiodes:</strong><br>`;
        starts.forEach((s, i) => html += `‚Ä¢ ${s} t/m ${ends[i]}<br>`);
    }

    html += `<br><strong>Muziek:</strong> ${getVals('music[]')}<br>`;
    html += `<strong>Festivals:</strong> ${getVals('festival[]')}<br>`;

    document.getElementById('reviewBox').innerHTML = html;
  }


  // --- KALENDER LOGICA (ingekort maar werkend) ---
  const startBound = new Date(2025,10,1); 
  const endBound = new Date(2026,11,31);
  const daysGrid = document.getElementById('daysGrid');
  const monthTitle = document.getElementById('monthTitle');
  const addRangeBtn = document.getElementById('addRangeBtn');
  const rangesList = document.getElementById('rangesList');
  const hiddenRanges = document.getElementById('hiddenRangesContainer');
  
  let viewDate = new Date(startBound);
  let selStart = null, selEnd = null;
  let ranges = [];

  function renderCal(){
    monthTitle.innerText = viewDate.toLocaleDateString('nl-NL', {month:'long', year:'numeric'});
    daysGrid.innerHTML = '';
    
    const y = viewDate.getFullYear(), m = viewDate.getMonth();
    const firstDay = new Date(y, m, 1).getDay(); // 0=zo, 1=ma...
    const offset = (firstDay + 6) % 7; // fix maandag start
    const daysInMonth = new Date(y, m+1, 0).getDate();

    for(let i=0; i<offset; i++) daysGrid.innerHTML += '<div></div>';

    for(let d=1; d<=daysInMonth; d++){
        const date = new Date(y, m, d);
        const el = document.createElement('div');
        el.className = 'day';
        el.innerText = d;
        
        // Check ranges
        ranges.forEach(r => {
             if(date >= r.start && date <= r.end) el.classList.add('in-range');
             if(date.getTime() === r.start.getTime()) el.classList.add('start');
             if(date.getTime() === r.end.getTime()) el.classList.add('end');
        });

        // Check selectie
        if(selStart && date.getTime() === selStart.getTime()) el.classList.add('start');
        if(selEnd && date.getTime() === selEnd.getTime()) el.classList.add('end');
        if(selStart && selEnd && date > selStart && date < selEnd) el.classList.add('in-range');

        el.onclick = () => {
            if(!selStart || (selStart && selEnd)) { selStart = date; selEnd = null; }
            else { if(date < selStart) { selEnd=selStart; selStart=date; } else selEnd = date; }
            addRangeBtn.disabled = !(selStart && selEnd);
            renderCal();
        };
        daysGrid.appendChild(el);
    }
  }

  document.getElementById('prevMonth').onclick = () => { viewDate.setMonth(viewDate.getMonth()-1); renderCal(); };
  document.getElementById('nextMonth').onclick = () => { viewDate.setMonth(viewDate.getMonth()+1); renderCal(); };

  addRangeBtn.onclick = () => {
    if(selStart && selEnd){
        ranges.push({start: new Date(selStart), end: new Date(selEnd)});
        selStart = null; selEnd = null;
        addRangeBtn.disabled = true;
        updateRangesUI();
        renderCal();
    }
  };

  function updateRangesUI(){
    rangesList.innerHTML = ranges.map((r, i) => 
        `<div>üìÖ ${r.start.toLocaleDateString()} - ${r.end.toLocaleDateString()} <span style="color:red;cursor:pointer;" onclick="removeRange(${i})">x</span></div>`
    ).join('');
    
    hiddenRanges.innerHTML = ranges.map(r => 
        `<input type="hidden" name="travel_start[]" value="${fmtISO(r.start)}">
         <input type="hidden" name="travel_end[]" value="${fmtISO(r.end)}">`
    ).join('');
  }

  window.removeRange = (i) => { ranges.splice(i, 1); updateRangesUI(); renderCal(); };
  function fmtISO(d){ return d.toISOString().split('T')[0]; } // YYYY-MM-DD

  renderCal();
})();
</script>
{% endblock %}